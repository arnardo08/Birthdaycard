<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Carta y Happy Birthday</title>

<link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Great+Vibes&display=swap" rel="stylesheet">

<style>
  body {
    margin: 0;
    font-family: 'Patrick Hand', cursive;
    overflow: hidden;
    background: #f0f0f0;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    position: relative;
    transition: background 2s ease;
  }

  /* Contenedor de la carta */
  #container {
    width: 80vw;
    max-width: 400px;
    position: relative;
    transform-origin: top center;
    z-index: 2;
  }

  .sobre {
    position: relative;
    width: 100%;
    height: 35vh;
    max-height: 300px;
    perspective: 1600px;
    z-index: 2;
  }

  .sobre-base {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #ffb6c1, #8a2be2);
    border-radius: 0 0 12px 12px;
    z-index: 1;
  }

  .solapa {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 55%;
    background: #9b2fbf;
    clip-path: polygon(0 0, 100% 0, 50% 100%);
    transform-origin: top;
    transition: transform 0.8s ease;
    z-index: 3;
    backface-visibility: visible;
  }

  .solapa::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 6px;
    background: linear-gradient(to bottom, #9b2fbf, #ffb6c1);
    pointer-events: none;
  }

  .solapa.abierta { transform: rotateX(180deg); }

  .slide-out {
    transform: translateY(120vh);
    opacity: 0;
    transition: transform 1s ease, opacity 1s ease;
  }

  .carta {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 70vw;
    max-width: 400px;
    height: 70vh;
    max-height: 700px;
    background: #f5e1b3;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.25);
    padding: 2.5vh 3vw;
    opacity: 0;
    z-index: 10;
    transform: translate(-50%, -50%) scale(1);
    transition: transform 1s ease, opacity 1s ease;
    font-family: 'Patrick Hand', cursive;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
  }
  .carta::-webkit-scrollbar { display: none; }

  .slide-in {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1.15);
  }

  .mensaje {
    opacity: 0;
    white-space: pre-wrap;
    font-size: clamp(18px, 4vw, 22px);
  }
  .mensaje strong { font-weight: bold; }
  .cursor {
    display: inline-block;
    width: 2px;
    background-color: black;
    margin-left: 2px;
    vertical-align: bottom;
    animation: blink 1s infinite;
  }
  @keyframes blink {
    0%,50%,100% { opacity: 1; }
    25%,75% { opacity: 0; }
  }

  /* Happy Birthday overlay */
  #birthday {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: black;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    opacity: 0;
    z-index: 50;
    transition: opacity 2s ease;
    overflow: hidden;
  }

  #birthday h1, #birthday h2 { 
    position: relative; z-index: 3; text-align: center; pointer-events: none; max-width: 92vw; width: 100%; 
  }

  /* Banner that bounces edge-to-edge above the title; only text (no background) */
  #banner {
    position: absolute;
    top: 6vh;
    left: 50%;
    transform: translateX(-50%);
    width: 100%;
    overflow: hidden;
    z-index: 60;
    pointer-events: none;
  }
  .banner-text {
    display: inline-block;
    white-space: nowrap;
    color: #fff;
    font-family: 'Great Vibes', cursive;
    font-size: clamp(2rem, 8vw, 5rem);
    padding: 0;
    background: none;
    border-radius: 0;
   /* position start fully off-screen left */
   transform: translateX(calc(-100vw - 100%));
   /* run once from left -> right and stay out of view afterward (slower)
     translate final uses viewport + own width so it ends fully off-screen */
   animation: slideOnce 14s ease-in-out 0s 1 forwards;
    will-change: transform, opacity;
    text-shadow: 0 6px 18px rgba(0,0,0,0.55);
  }
  @keyframes slideOnce {
    0% { transform: translateX(calc(-100vw - 100%)); opacity: 0; }
    8% { opacity: 1; }
    /* remain fully opaque during travel and finish fully off-screen right */
    100% { transform: translateX(calc(100vw + 100%)); opacity: 1; }
  }

  #birthday h1 {
    font-size: clamp(3.2rem, 8vw, 7.5rem);
    margin: 0;
    color: white;
    animation: popUp 0.6s ease-out forwards;
  }

  #birthday h2 {
    font-family: 'Great Vibes', cursive;
    font-size: clamp(4rem, 14vw, 9.5rem);
    margin: 70px 0 0 0;
    overflow: visible;
    display: inline-block;
    padding-inline: 12px;
    opacity: 0;
    background: linear-gradient(90deg, #ff6aa2, #ffd166, #6ef1e0, #ff6aa2);
    background-size: 200% 200%;
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: riseBounce 0.9s cubic-bezier(.2,.9,.3,1) forwards, float 3s ease-in-out infinite, gradientMove 6s linear infinite;
    animation-delay: 0.6s, 1.5s, 0s;
    animation-fill-mode: forwards;
    font-weight: 400;
    text-shadow: 0 6px 18px rgba(0,0,0,0.55);
    letter-spacing: 0.4px;
    line-height: 1.22;
  }

  @keyframes gradientMove { 0%{background-position:0% 50%;}50%{background-position:100% 50%;}100%{background-position:0% 50%;} }
  @keyframes popUp { 0%{transform:scale(0.2);opacity:0;}60%{transform:scale(1.2);opacity:1;}80%{transform:scale(0.95);}100%{transform:scale(1);} }
  @keyframes riseBounce {0%{transform:translateY(100px);opacity:0;}60%{transform:translateY(-20px);opacity:1;}80%{transform:translateY(10px);}100%{transform:translateY(0);opacity:1;} }
  @keyframes float {0%,100%{transform:translateY(0);}50%{transform:translateY(-10px);}}

  canvas { position: absolute; top:0; left:0; z-index:-2; }
</style>
</head>
<body>

<div id="container">
  <div class="sobre" id="sobre">
    <div class="sobre-base"></div>
    <div class="solapa" id="solapa"></div>
  </div>

  <div class="carta" id="carta">
    <div class="mensaje" id="mensaje"></div>
  </div>
</div>

<!-- Happy Birthday overlay -->
<div id="birthday">
  <div id="banner"><span class="banner-text">Espero lo pases super</span></div>
  <h1 id="title">Happy Birthday</h1>
  <h2 id="name">Massiel</h2>
  <canvas id="fireworks"></canvas>
</div>

<script>
const cartaTexto = [
  { text: "Dear Massiel Rodriguez,\n\n", bold: ["Dear"] },
  { text: "Date: October 2nd 2025\n\n", bold: ["Date"] },
  { text: "Hola, espero que te encuentres muy bien, especialmente hoy. Sabes, no soy de muchas palabras, pero quise realmente tomarme el tiempo de expresarte algunas, aunque no fueran audibles.\n\n", bold: [] },
  { text: "Eres una señorita muy agradable, ", bold: [] },
  { text: "breathtaking", bold: ["breathtaking"] },
  { text: " by the way. Cocinas muy rico, casi igual o mejor que tu viejita (¡cuidado con tirarme pa'lante!).", bold: [] },
  { text: "Aunque hace mucho que no tengo el placer de probar tu sazón por ser vergonzoso y mañoso.\n\n", bold: [] },
  { text: "Eres una excelente profesora; se nota por cómo a veces compartes momentos con tus alumnos. De verdad, cabe remarcar que eres una de las profesionales que rompen el molde en el buen sentido, mostrando que te importa su formación y su bienestar, enseñándoles con pasión y entrega.\n\n", bold: [] },
  { text: "Y, con todo el respeto que te mereces, el joven que te tiene como su norte de verdad enorgullecería a cualquier buen padre.\n\n", bold: [] },
  { text: "Por último, y más importante, tienes la gracia que Dios puso en ti como líder. Manda mucho, pero no cualquiera sabe mandar. jsjsjs. Pero de verdad, espero que Dios te siga usando y que pueda seguir bendiciéndote como lo ha estado haciendo.\n\n", bold: [] },
  { text: "No quiero terminar esto sin antes decirte que:\n\n", bold: [] },
  { text: "You are very special for many people, including me. That's why I want to tell you…\n", bold: ["You are very special for many people, including me. That's why I want to tell you…\n"] }
];



window.onload = () => {
  const solapa = document.getElementById('solapa');
  const sobre = document.getElementById('sobre');
  const carta = document.getElementById('carta');
  const mensaje = document.getElementById('mensaje');

  setTimeout(() => {
    solapa.classList.add('abierta');

    solapa.addEventListener('transitionend', function handler() {
      solapa.removeEventListener('transitionend', handler);
      sobre.classList.add('slide-out');
      carta.classList.add('slide-in');

      setTimeout(() => typeWriter(mensaje, cartaTexto, startBirthday), 500);
    });
  }, 200);

  // try to start background audio on page load
  try { playSegment(); } catch (e) { /* will fallback to user gesture in playSegment */ }
};



// Typing effect con pausas, negritas y autoscroll
function typeWriter(container, textArray, callback, startSection = 0) {
  container.innerHTML = '';
  container.style.opacity = 1;
  const cursor = document.createElement('span');
  cursor.className = 'cursor';
  container.appendChild(cursor);

  let sectionIndex = startSection || 0;
  let charIndex = 0;
  let insideBold = false;
  let boldSpan = null;
  // ensure the error-typing sequence only happens once
  let errorTriggered = false;
  // when true, typing is paused for the error-delete sequence
  let isPausedForError = false;

  function removeLastCharacter() {
    // Remove the character immediately before the cursor
    let node = cursor.previousSibling;
    if(!node) return;

    // If the previous node is a text node, remove last char
    if(node.nodeType === Node.TEXT_NODE){
      const txt = node.textContent;
      if(txt.length > 1) node.textContent = txt.slice(0, -1);
      else node.parentElement.removeChild(node);
      return;
    }

    // If it's an element (e.g. <strong>), try to remove its last text node char
    if(node.nodeType === Node.ELEMENT_NODE){
      const last = node.lastChild;
      if(last && last.nodeType === Node.TEXT_NODE){
        const t = last.textContent;
        if(t.length > 1) last.textContent = t.slice(0, -1);
        else node.removeChild(last);
        // if element is now empty, remove it
        if(!node.textContent) node.parentElement.removeChild(node);
        return;
      }
      // fallback: remove the element entirely
      node.parentElement.removeChild(node);
    }
  }

  function typeChar() {
    if(window.forceStopTyping){
      window.forceStopTyping = false;
      // clear and render previous sections up to sectionIndex-1
      container.innerHTML = '';
      container.appendChild(cursor);
      for(let i=0;i<sectionIndex;i++){
        container.insertBefore(document.createTextNode(textArray[i].text), cursor);
      }
    }
    // if startSection > 0 and container only has cursor, render previous sections instantly
    if(container.textContent.trim() === '' && sectionIndex > 0 && container.children.length === 1){
      for(let i=0;i<sectionIndex;i++){
        container.insertBefore(document.createTextNode(textArray[i].text), cursor);
      }
    }
    if(isPausedForError) return; // don't do any typing while paused
    if(isPausedForError) return; // don't do any typing while paused
    if(sectionIndex >= textArray.length){
      container.appendChild(cursor);
      setTimeout(callback, 1000);
      return;
    }

    const section = textArray[sectionIndex];
    const text = section.text;
    const boldWords = section.bold || [];

    if(charIndex >= text.length){
      sectionIndex++;
      charIndex = 0;
      insideBold = false;
      boldSpan = null;
      setTimeout(typeChar, 600);
      return;
    }

    const c = text[charIndex];

    // verificar si inicia palabra bold
    let isBold = false;
    for(const w of boldWords){
      if(text.substr(charIndex, w.length) === w){
        isBold = true;
        if(!insideBold){
          boldSpan = document.createElement('strong');
          container.insertBefore(boldSpan, cursor);
          insideBold = true;
        }
        break;
      }
    }

    if(insideBold){
      boldSpan.textContent += c;
      let currentText = boldSpan.textContent;
      if(!boldWords.some(w => w.startsWith(currentText) && w.length > currentText.length)){
        insideBold = false;
        boldSpan = null;
      }
    } else {
      container.insertBefore(document.createTextNode(c), cursor);
    }

    charIndex++;
    container.parentElement.scrollTop = container.parentElement.scrollHeight;

    // If we just wrote a closing parenthesis in the target sentence and we haven't
    // triggered the error sequence yet, start the pause->delete flow.
    if(c === ')' && !errorTriggered && container.textContent.indexOf('casi') !== -1){
      // more robust: detect 'casi' anywhere already typed in the container
      errorTriggered = true;
      isPausedForError = true;

      // wait 1 second, then delete characters that belong to the last occurrence of 'casi'
      setTimeout(() => {
        const textNow = container.textContent || '';
        const idx = textNow.lastIndexOf('casi');
        if(idx === -1){
          // nothing to delete, resume after small pause
          setTimeout(() => {
            isPausedForError = false;
            sectionIndex++;
            charIndex = 0;
            insideBold = false;
            boldSpan = null;
            typeChar();
          }, 1000);
          return;
        }

        // number of characters after the start of 'casi' to delete
        let deleteCount = (container.textContent || '').length - idx;
        // safety cap
        deleteCount = Math.min(deleteCount, 2000);

        let deleted = 0;
        function doDeleteExact() {
          if(deleted >= deleteCount){
            // finished deleting the whole occurrence; wait 1s then resume
            setTimeout(() => {
              isPausedForError = false;
              sectionIndex++;
              charIndex = 0;
              insideBold = false;
              boldSpan = null;
              typeChar();
            }, 1000);
            return;
          }
          removeLastCharacter();
          deleted++;
          container.parentElement.scrollTop = container.parentElement.scrollHeight;
          setTimeout(doDeleteExact, 60);
        }

        doDeleteExact();
      }, 1000);

      // stop normal scheduling — the flow will resume after the deletion sequence
      return;
    }

    let delay = 100;
    if(c === '.' || c === '?' || c === '!') delay = 500;
    if(c === '\n') delay = 800;

    setTimeout(typeChar, delay);
  }

  typeChar();
}

// FUNCION QUE INICIA HAPPY BIRTHDAY
function startBirthday(){
  document.body.style.background = 'black';
  const birthday = document.getElementById('birthday');
  birthday.style.opacity = 1;

  // restart banner animation so it runs when the overlay becomes visible
  const bannerText = document.querySelector('#banner .banner-text');
  if(bannerText){
    bannerText.style.animation = 'none';
    // force reflow
    // eslint-disable-next-line no-unused-expressions
    bannerText.offsetWidth;
    // delay before starting the banner so it appears a bit later
    setTimeout(() => {
      bannerText.style.animation = 'slideOnce 14s ease-in-out 0s 1 forwards';
    }, 2000);
  }

  // Iniciar canvas de fuegos artificiales
  const canvas = document.getElementById('fireworks');
  const ctx = canvas.getContext('2d');

  

  function resizeCanvas() {
    const dpr = window.devicePixelRatio || 1;
    canvas.width = window.innerWidth * dpr;
    canvas.height = window.innerHeight * dpr;
    canvas.style.width = window.innerWidth + 'px';
    canvas.style.height = window.innerHeight + 'px';
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  resizeCanvas();
  window.addEventListener('resize', resizeCanvas);

  const h1 = document.getElementById("title");
  const h2 = document.getElementById("name");

  function getTextBoxes() {
    const rect1 = h1.getBoundingClientRect();
    const rect2 = h2.getBoundingClientRect();
    return [
      {x: rect1.left, y: rect1.top, w: rect1.width, h: rect1.height},
      {x: rect2.left, y: rect2.top, w: rect2.width, h: rect2.height}
    ];
  }

  class Projectile {
    constructor(x, targetY, color) {
      this.x = x; this.y = canvas.clientHeight; this.targetY = targetY;
      this.color = color; this.radius = 3; this.speedY = -7; this.exploded=false; this.alpha=1;
    }
    update(textBoxes){
      if(!this.exploded){
        this.y += this.speedY;
        for(let box of textBoxes){
          if(this.x>=box.x && this.x<=box.x+box.w && this.y>=box.y && this.y<=box.y+box.h){
            this.exploded=true; explode(this.x,this.y,this.color); return;
          }
        }
        if(this.y<=this.targetY){ this.exploded=true; explode(this.x,this.y,this.color); }
      }else this.alpha-=0.04;
    }
    draw(){
      if(this.alpha>0){ ctx.save(); ctx.globalAlpha=this.alpha; ctx.beginPath(); ctx.arc(this.x,this.y,this.radius,0,Math.PI*2); ctx.fillStyle=this.color; ctx.fill(); ctx.restore(); }
    }
  }

  class Particle {
    constructor(x,y,color){ this.x=x; this.y=y; this.radius=Math.random()*3+2; this.color=color; this.speedX=(Math.random()-0.5)*8; this.speedY=(Math.random()-0.5)*8; this.alpha=1; }
    update(){ this.x+=this.speedX; this.y+=this.speedY; this.alpha-=0.015; }
    draw(){ if(this.alpha>0){ ctx.save(); ctx.globalAlpha=this.alpha; ctx.beginPath(); ctx.arc(this.x,this.y,this.radius,0,Math.PI*2); ctx.fillStyle=this.color; ctx.fill(); ctx.restore(); } }
  }

  const colors=['#ff0040','#00ffd5','#ffff00','#ff8000','#00ff00','#ff00ff'];
  let particles=[]; let projectiles=[];

  function explode(x,y,color){ for(let i=0;i<30;i++){particles.push(new Particle(x,y,color));} }

  function animate(){
    ctx.fillStyle="rgba(0,0,0,0.2)";
    ctx.fillRect(0,0,canvas.width,canvas.height);
    const textBoxes=getTextBoxes();
    for(let p of projectiles){ p.update(textBoxes); p.draw(); }
    for(let p of particles){ p.update(); p.draw(); }
    projectiles=projectiles.filter(p=>!(p.exploded&&p.alpha<=0));
    particles=particles.filter(p=>p.alpha>0);
    requestAnimationFrame(animate);
  }

  setInterval(()=>{ const x=Math.random()*canvas.clientWidth; const targetY=Math.random()*canvas.clientHeight*0.5; const color=colors[Math.floor(Math.random()*colors.length)]; projectiles.push(new Projectile(x,targetY,color)); }, 700);
  animate();
}
</script>

</body>
</html>
